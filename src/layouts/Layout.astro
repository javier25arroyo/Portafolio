---
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';
import '../styles/shared.css';
import '../styles/fixes.css';
const isProd = import.meta.env.PROD;
---
<!doctype html>
<html lang="en" class="font-sans scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Performance Critical Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://walink.co">
    <link rel="dns-prefetch" href="https://github.com">
    <link rel="dns-prefetch" href="https://linkedin.com">
    
    <!-- Critical Resource Preloads -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap"></noscript>
    
    <!-- Favicon configuration - Optimized -->
    <link rel="icon" type="image/x-icon" href={`${import.meta.env.BASE_URL}favicon.ico`} />
    <link rel="apple-touch-icon" sizes="180x180" href={`${import.meta.env.BASE_URL}assets/icons/favicon.ico`} />
    <link rel="icon" type="image/png" sizes="32x32" href={`${import.meta.env.BASE_URL}assets/icons/favicon.ico`} />

    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#4F46E5" />
    <meta name="msapplication-TileColor" content="#4F46E5" />
    
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO Optimizado -->
    <title>Javier Arroyo | Software Developer Portfolio</title>
    <meta name="description" content="Software Development Engineer specializing in modern web technologies. Explore my portfolio of innovative projects built with JavaScript, TypeScript, React, and more." />
    <meta name="keywords" content="software development engineer, web developer, portfolio, JavaScript, TypeScript, React, Node.js, full-stack developer, Javier Arroyo" />
    <meta name="author" content="Javier Arroyo Rojas" />
    
    <!-- Open Graph -->
    <meta property="og:title" content="Javier Arroyo - Software Development Engineer" />
    <meta property="og:description" content="Software Development Engineer specializing in modern web technologies. View my portfolio and connect with me." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://javier25arroyo.github.io/Portafolio" />
    <meta property="og:site_name" content="Javier Arroyo Portfolio" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Javier Arroyo - Software Developer" />
    <meta name="twitter:description" content="Software Development Engineer specializing in modern web technologies" />
    
    <!-- Critical CSS Inline -->
    <style is:inline>
      /* Critical above-the-fold styles */
      *, *::before, *::after {
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
        scroll-padding-top: 80px;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: #0B0D17;
        color: #F1F5F9;
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }

      /* Initial loading state */
      .page-loading {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
                    transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .page-loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* Hero critical styles */
      .hero-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0B0D17 0%, #151825 50%, #1F2337 100%);
      }

      /* Navigation critical styles */
      nav {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 50;
        backdrop-filter: blur(10px);
        background: rgba(11, 13, 23, 0.8);
      }
    </style>
    
    <!-- Performance monitoring script inline -->
    <script is:inline>
      // Performance monitoring
      if ('performance' in window) {
        window.addEventListener('load', () => {
          setTimeout(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
            }
          }, 0);
        });
      }
    </script>
    
    <!-- Script para corregir rutas en GitHub Pages - Defer (production only) -->
    {isProd && (
      <script is:inline define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
        const script = document.createElement('script');
        script.src = baseUrl + 'fixPaths.js';
        script.defer = true;
        document.head.appendChild(script);
      </script>
    )}
  </head>
  
  <body class="page-loading">
    <!-- NavegaciÃ³n -->
    <Navigation />
    
    <!-- Contenido principal -->
    <main id="main-content" class="min-h-screen relative">
      <slot />
    </main>
    
    <!-- Footer -->
    <Footer />
    
    <!-- Componentes UX optimizados -->
    <div id="scroll-progress" class="fixed top-0 left-0 w-full h-1 z-30 scroll-progress-bg">
      <div id="scroll-progress-bar" class="h-full transition-all duration-300 ease-out scroll-progress-bar" style="width: 0%;"></div>
    </div>
    
    <button 
      id="back-to-top" 
      class="fixed bottom-8 right-8 w-14 h-14 rounded-full shadow-lg transition-all duration-300 transform opacity-0 pointer-events-none z-30 glass-elevated hover:neon-glow back-to-top-btn"
      aria-label="Back to top"
      data-track="back-to-top"
    >
      <svg class="w-6 h-6 mx-auto back-to-top-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
      </svg>
    </button>
    
    <div id="page-loader" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-500 page-loader" style="display: none;">
    </div>

    <!-- Deferred JavaScript for better performance -->
    <script>
      // Optimized DOMContentLoaded handler
      const initializeApp = () => {
        // Remove loading class
        document.body.classList.remove('page-loading');
        document.body.classList.add('page-loaded');

        // === SMOOTH SCROLL OPTIMIZADO ===
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
              // Obtener altura del navbar
              const navbarHeight = document.querySelector('nav')?.offsetHeight || 80;
              const additionalOffset = 32; // 2rem adicional
              const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
              const offsetPosition = targetPosition - navbarHeight - additionalOffset;

              window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
              });

              // Actualizar URL sin saltar
              history.pushState(null, '', targetId);
            }
          });
        });

        // === ENHANCED INTERSECTION OBSERVER FOR REVEAL ANIMATIONS ===
        const revealObserverOptions = {
          threshold: [0, 0.1, 0.2, 0.3],
          rootMargin: '0px 0px -80px 0px'
        };

        const revealObserver = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && entry.intersectionRatio >= 0.1) {
              // Add revealed class with a small delay for smoother effect
              requestAnimationFrame(() => {
                entry.target.classList.add('revealed');
              });
              revealObserver.unobserve(entry.target);
            }
          });
        }, revealObserverOptions);

        // Observe all reveal elements (including variants)
        const revealSelectors = '.reveal, .reveal-fade, .reveal-left, .reveal-right, .reveal-scale, .reveal-rotate';
        document.querySelectorAll(revealSelectors).forEach(el => {
          revealObserver.observe(el);
        });

        // === SECTION VISIBILITY OBSERVER ===
        const sectionObserverOptions = {
          threshold: [0, 0.15, 0.3, 0.5],
          rootMargin: '-10% 0px -10% 0px'
        };

        const sectionObserver = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const section = entry.target;
            
            if (entry.isIntersecting) {
              // Smooth section entrance
              section.style.opacity = '1';
              section.style.transform = 'translateY(0)';
              
              // Add active class for potential styling
              section.classList.add('section-active');
              
              // Trigger staggered children animations
              const staggerContainer = section.querySelector('.reveal-stagger');
              if (staggerContainer) {
                staggerContainer.querySelectorAll('.reveal, .reveal-scale, .reveal-left, .reveal-right').forEach(child => {
                  child.classList.add('revealed');
                });
              }
            } else {
              section.classList.remove('section-active');
            }
          });
        }, sectionObserverOptions);

        // Observe all sections
        document.querySelectorAll('section[id]').forEach(section => {
          sectionObserver.observe(section);
        });

        // Optimized scroll handler with throttling
        let scrollTimeout;
        const handleScrollOptimized = () => {
          if (scrollTimeout) return;
          
          scrollTimeout = setTimeout(() => {
            updateScrollProgress();
            toggleBackToTop();
            scrollTimeout = null;
          }, 16); // ~60fps
        };

        function updateScrollProgress() {
          const scrollProgress = document.getElementById('scroll-progress-bar');
          if (!scrollProgress) return;
          
          const scrollTop = window.pageYOffset;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);
          
          scrollProgress.style.width = scrollPercent + '%';
        }

        function toggleBackToTop() {
          const backToTop = document.getElementById('back-to-top');
          if (!backToTop) return;
          
          const scrollTop = window.pageYOffset;
          
          if (scrollTop > 300) {
            backToTop.classList.remove('opacity-0', 'pointer-events-none');
            backToTop.classList.add('opacity-100', 'pointer-events-auto');
          } else {
            backToTop.classList.add('opacity-0', 'pointer-events-none');
            backToTop.classList.remove('opacity-100', 'pointer-events-auto');
          }
        }

        // Event listeners
        window.addEventListener('scroll', handleScrollOptimized, { passive: true });
        
        const backToTop = document.getElementById('back-to-top');
        if (backToTop) {
          backToTop.addEventListener('click', (e) => {
            e.preventDefault();
            window.scrollTo({
              top: 0,
              behavior: 'smooth'
            });
          });
        }

        // Hide loader
        const loader = document.getElementById('page-loader');
        if (loader) {
          loader.style.display = 'none';
        }
      };

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    </script>
  </body>
</html>