---
/**
 * ThemeToggleButton.astro
 * 
 * Componente de alternancia de tema (claro/oscuro) con experiencia de usuario premium
 * 
 * Características:
 * - Animaciones fluidas en la transición entre temas
 * - Efecto ripple en la interacción
 * - Feedback háptico (vibración) en dispositivos que lo soportan
 * - Compatibilidad con teclado y navegación por teclado
 * - Soporte para lectores de pantalla con notificaciones de cambio de tema
 * - Optimizado para preferencias de reducción de movimiento
 * - Diseño adaptable y estético
 */
---
<!-- Componente ThemeToggleButton - Versión simplificada para depuración -->
<div class="theme-toggle-container">
  <style>
    .theme-toggle-btn {
      background-color: #f1f5f9;
      border-radius: 9999px;
      cursor: pointer;
      display: flex;
      height: 2.5rem;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
      width: 5rem;
    }
    
    .dark .theme-toggle-btn {
      background-color: #1e293b;
    }
    
    .toggle-slider {
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      height: 2rem;
      left: 0.25rem;
      position: absolute;
      top: 0.25rem;
      transition: transform 0.3s ease;
      width: 2rem;
    }
    
    .dark .toggle-slider {
      background-color: #334155;
      transform: translateX(2.5rem);
    }
    
    .toggle-icon {
      align-items: center;
      color: #334155;
      display: flex;
      font-size: 1.25rem;
      height: 100%;
      justify-content: center;
      position: absolute;
      top: 0;
      transition: opacity 0.5s cubic-bezier(.4,0,.2,1), transform 0.7s cubic-bezier(.4,0,.2,1);
      /* Se añade transición de transform */
      z-index: 2;
    }
    .toggle-icon-bg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: rgba(51, 65, 85, 0.12); /* fondo oscuro sutil para contraste */
      z-index: 0;
      pointer-events: none;
      transition: background 0.3s;
    }
    .dark .toggle-icon-bg {
      background: rgba(226, 232, 240, 0.18); /* fondo claro sutil en modo oscuro */
    }
    .toggle-icon img {
      width: 1.5rem;
      height: 1.5rem;
      display: block;
      position: relative;
      z-index: 1;
      transition: transform 0.7s cubic-bezier(.4,0,.2,1), opacity 0.5s cubic-bezier(.4,0,.2,1);
      will-change: transform, opacity;
    }
    .toggle-icon.sun {
      opacity: 1;
      right: 0.25rem;
      /* Estado inicial: sin rotación */
    }
    
    .toggle-icon.moon {
      left: 0.25rem;
      opacity: 0;
      /* Estado inicial: sin rotación */
    }
    
    /* Animación al activar modo oscuro */
    .theme-toggle-btn.theme-animating .toggle-icon.sun img {
      transform: rotate(180deg) scale(0.7);
      opacity: 0;
    }
    .theme-toggle-btn.theme-animating .toggle-icon.sun {
      opacity: 0;
    }
    .theme-toggle-btn.theme-animating .toggle-icon.moon img {
      transform: rotate(-180deg) scale(1);
      opacity: 1;
    }
    .theme-toggle-btn.theme-animating .toggle-icon.moon {
      opacity: 1;
    }
    /* Estado final en modo oscuro */
    .dark .toggle-icon.sun {
      opacity: 0;
    }
    .dark .toggle-icon.moon {
      color: #e2e8f0;
      opacity: 1;
    }
    /* Estado final: luna visible, sol oculto */
    .dark .toggle-icon.sun img {
      opacity: 0;
      transform: rotate(180deg) scale(0.7);
    }
    .dark .toggle-icon.moon img {
      opacity: 1;
      transform: rotate(0deg) scale(1);
    }
    /* Estado inicial: sol visible, luna oculta */
    .toggle-icon.sun img {
      opacity: 1;
      transform: rotate(0deg) scale(1);
    }
    .toggle-icon.moon img {
      opacity: 0;
      transform: rotate(-180deg) scale(0.7);
    }
    /* Para accesibilidad */
    .theme-toggle-input {
      height: 1px;
      left: -9999px;
      position: absolute;
      width: 1px;
    }
    
    .theme-toggle-input:focus + .theme-toggle-btn {
      outline: 2px solid #3b82f6;
    }
    
    .sr-only {
      border: 0;
      clip: rect(0, 0, 0, 0);
      height: 1px;
      margin: -1px;
      overflow: hidden;
      padding: 0;
      position: absolute;
      white-space: nowrap;
      width: 1px;
    }
  </style>

  <div class="theme-toggle-wrapper">
    <input 
      type="checkbox" 
      id="theme-toggle" 
      class="theme-toggle-input" 
      aria-label="Cambiar tema" 
    />
    <label for="theme-toggle" class="theme-toggle-btn">
      <div class="toggle-slider"></div>
      <div class="toggle-icon moon">
        <span class="toggle-icon-bg"></span>
        <img src="/src/assets/icons/dark_mode.svg" alt="Modo oscuro" />
      </div>
      <div class="toggle-icon sun">
        <span class="toggle-icon-bg"></span>
        <img src="/src/assets/icons/light_mode.svg" alt="Modo claro" />
      </div>
    </label>
    <div id="theme-status" class="sr-only" role="status" aria-live="polite"></div>
  </div>
</div>
<script>
  // Definición global para TypeScript
  declare global {
    interface Window {
      toggleThemeWithAnimation?: () => void;
    }
  }

  // Función simplificada para inicializar el botón de tema
  function setupThemeToggle() {
    try {
      console.log("Inicializando botón de tema...");
      const toggleInput = document.getElementById('theme-toggle') as HTMLInputElement;
      const themeStatus = document.getElementById('theme-status');
      
      if (!toggleInput) {
        console.error("No se encontró el input del toggle de tema");
        return;
      }
      
      // Configurar estado inicial según el tema actual
      const isDarkMode = document.documentElement.classList.contains('dark');
      toggleInput.checked = isDarkMode;
      
      if (themeStatus) {
        themeStatus.textContent = isDarkMode 
          ? "Tema oscuro activado" 
          : "Tema claro activado";
      }
      
      // Evento de cambio en el toggle
      toggleInput.addEventListener('change', () => {
        try {
          // Animación de iconos
          const isDark = !document.documentElement.classList.contains('dark');
          animateThemeIcons(isDark);

          // Intentar usar la función global de animación si está disponible
          if (typeof window.toggleThemeWithAnimation === 'function') {
            console.log("Usando función global de animación de tema");
            window.toggleThemeWithAnimation();
          } else {
            // Fallback básico para cambiar tema
            console.log("Usando fallback para cambiar tema");
            const html = document.documentElement;
            const newIsDark = !html.classList.contains('dark');
            
            if (newIsDark) {
              html.classList.add('dark');
              localStorage.setItem('theme', 'dark');
            } else {
              html.classList.remove('dark');
              localStorage.setItem('theme', 'light');
            }
            
            // Actualizar estado para accesibilidad
            if (themeStatus) {
              themeStatus.textContent = newIsDark 
                ? "Tema oscuro activado" 
                : "Tema claro activado";
            }
          }
        } catch (error) {
          console.error("Error al cambiar el tema:", error);
        }
      });
      
      // Soporte de accesibilidad para teclado
      toggleInput.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') {
          e.preventDefault();
          toggleInput.click();
        }
      });
      
      // Observar cambios en el tema para actualizar el toggle
      const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (mutation.attributeName === 'class') {
            const isDark = document.documentElement.classList.contains('dark');
            toggleInput.checked = isDark;
            
            if (themeStatus) {
              themeStatus.textContent = isDark 
                ? "Tema oscuro activado" 
                : "Tema claro activado";
            }
          }
        }
      });
      
      observer.observe(document.documentElement, { 
        attributes: true, 
        attributeFilter: ['class'] 
      });
      
      console.log("Botón de tema inicializado correctamente");
    } catch (error) {
      console.error("Error al configurar el botón de tema:", error);
    }
  }

  // Añadir animación suave al cambiar el tema
  function animateThemeIcons(isDarkMode) {
    const btn = document.querySelector('.theme-toggle-btn');
    if (!btn) return;
    btn.classList.add('theme-animating');
    setTimeout(() => {
      btn.classList.remove('theme-animating');
    }, 700); // Duración igual a la transición CSS
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupThemeToggle);
  } else {
    // Si ya está cargado, intentar inicializar
    window.setTimeout(setupThemeToggle, 100);
  }
</script>

<!--
  SOLUCIÓN DE PROBLEMAS Y DEPURACIÓN:
  
  Si tienes problemas con la visualización del botón de tema:
  
  1. Verifica la consola del navegador para mensajes de error.
  
  2. Asegúrate de que el componente Layout.astro importa correctamente este componente:
     import ThemeToggleButton from '../components/ThemeToggleButton.astro';
  
  3. Si tienes problemas con el cambio de tema, verifica que la función toggleThemeWithAnimation
     está correctamente definida y expuesta en Layout.astro:
     window.toggleThemeWithAnimation = toggleThemeWithAnimation;
     
  4. Esta es una versión simplificada para debugging. Una vez que funcione, puedes volver
     a implementar características avanzadas de UX/UI como los efectos ripple.
  
  5. El botón usa CSS puro en lugar de Tailwind para facilitar la depuración.
-->